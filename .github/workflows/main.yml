name: Appium Android Tests 

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  appium-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    # 1. Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. Setup Java
    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # 3. Setup Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # 4. Install Appium and UiAutomator2 driver
    - name: Install Appium and UiAutomator2
      run: |
        echo "Installing Appium..."
        npm install -g appium
        appium -v

        echo "Installing UiAutomator2 driver..."
        appium driver install uiautomator2

        echo "Installed drivers:"
        appium driver list

    # 5. Start Emulator + Run Appium Tests (FINAL WORKING VERSION)
    - name: Start Emulator and Run Appium Tests
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 30
        target: google_apis            # MUST use google_apis
        arch: x86                     # MUST be x86 (not x86_64)
        profile: pixel
        cores: 2
        ram-size: 3072M
        heap-size: 512M
        disk-size: 4096M
        disable-animations: true
        force-avd-creation: true
        emulator-boot-timeout: 600
        emulator-options: >
          -no-window
          -no-audio
          -no-boot-anim
          -no-snapshot
          -gpu swiftshader_indirect
          -accel off                  # ðŸ”´ CRITICAL FIX (software mode)
        script: |
          echo "===== Emulator Boot Process ====="

          echo "Waiting for emulator process..."
          adb wait-for-device

          echo "Allowing cold boot stabilization..."
          sleep 60

          echo "Restarting adb after emulator start..."
          adb kill-server
          adb start-server
          sleep 10

          echo "Waiting for device to become ONLINE..."
          while true; do
            STATE=$(adb devices | grep emulator | awk '{print $2}')
            if [ "$STATE" = "device" ]; then
              echo "âœ“ Device is ONLINE."
              break
            fi
            echo "Device state: $STATE , waiting..."
            sleep 10
          done

          echo "Waiting for system boot completion..."
          while true; do
            BOOT=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$BOOT" = "1" ]; then
              echo "âœ“ Emulator booted successfully."
              break
            fi
            echo "System not booted yet..."
            sleep 10
          done

          echo "Extra stabilization wait..."
          sleep 20

          echo "===== Device Information ====="
          adb devices -l
          echo "SDK Version: $(adb shell getprop ro.build.version.sdk)"
          echo "Android Version: $(adb shell getprop ro.build.version.release)"
          echo "Device Model: $(adb shell getprop ro.product.model)"

          # ðŸ”´ DO NOT UNLOCK SCREEN (causes DeadSystemException in CI)

          echo "Starting Appium server..."
          appium --log-level info --log appium.log &
          sleep 25

          echo "Checking Appium status..."
          curl -s http://127.0.0.1:4723/status

          echo "===== Running Maven Tests ====="
          mvn clean test -Dtest=NotepadTest

    # 6. Upload Appium Logs
    - name: Upload Appium Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: appium-logs
        path: appium.log
        if-no-files-found: warn

    # 7. Upload Test Reports
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports
        path: target/surefire-reports
        if-no-files-found: warn

    # 8. Upload Screenshots
    - name: Upload Screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-screenshots
        path: target/screenshots
        if-no-files-found: ignore
